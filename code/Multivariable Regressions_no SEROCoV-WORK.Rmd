---
title: "Multivariable Regressions without SEROCoV-WORK population source"
author: "Anshu Uppal"
date: "`r lubridate::today()`"
output: 
  html_document:
    code_folding: hide
knit: (function(input, ...) {
    rmarkdown::render(
      input, 
      output_dir = here::here("output")
    )
  })
---

```{r setup, results = "hide", message = FALSE, warning = FALSE}
knitr::opts_chunk$set(message = FALSE)  # Set default to not display code from chunks and not to display warnings
options(width = 300)
# Load packages and dataset ####
pacman::p_load(    # Installs / loads packages if they are not already installed / loaded
  rio,          # File import
  here,         # File locator
  skimr,        # get overview of data
  tidyverse,    # data management + ggplot2 graphics 
  gtsummary,    # summary statistics and tests
  rstatix,      # summary statistics and statistical tests
  janitor,      # adding totals and percents to tables
  scales,       # easily convert proportions to percents  
  flextable,    # converting tables to pretty images
  lubridate,    # manipulate date objects
  ggfortify,    # plotting tools to check GLM assumptions
  apyramid,     # a package dedicated to creating age pyramids
  car,           # Used for checking non-collinearity assumption for regressions
  plotly
)

# Read in clean dataset (see "Merge code.R" and "Cleaning merged dataset")
dat <- tibble(readRDS(here("data", "clean_dataset.rds"))) #%>% 
  # filter(pop_source != "SEROCoV-WORK")    ## Remove 
  # filter(!is.na(sex_en))
# dat_all <- tibble(readRDS(here("data", "clean_dataset_incl_salariee.rds"))) #%>%
  # filter(!is.na(sex_en))
```
# {.tabset}
## DAG
**DAG for choosing variables of interest**
`r knitr::include_graphics(here::here("data", "DAG.png"))`  
Should we try and account for situatuations where people indicated that they **teleworked more/less as a result of generally working more/less?**  
* Perhaps by including a variable showing the change in percentage that people worked at the time of the Inclusion questionnaire and at the time of the Santé-travail questionnaire?  
  
  
### Description of variables:  
**Outcomes:**  
* Linear regression  
  * Linear EE-MBI score
* Logistic regression  
  * Dichotomised EE-MBI score  
  * Diagnosed burnout
  
**Main exposure:** Composite variable `wfh_exposure` that combines two variables for WFH status and changes since the the pandemic:  

* `wfh_updated` re-categorized into three groups (Never, Not Possible, Yes) (`wfh_trich`)  
  * The `wfh_updated` variable was made from the `wfh` variable by cleaning the "Never" responses  
    * Cleaning process was to assign the most relevant ISCO-08 code I could find for each of the professions (only done for the "Never" responses).  
    * I then used a recently developed teleworkability index (https://joint-research-centre.ec.europa.eu/publications/teleworkability-and-covid-19-crisis-new-digital-divide_en) to assign a score for the physical feasibility of teleworking (from 0 to 1, where 0 = not at all physically feasible, up to 1 where it's completely physically feasible).  
    * "Never" responses were updated to "Not possible" under the following conditions:  
      * Physical feasibility of teleworking = 0  
      * Occupation category is one of: "Air traffic controllers", "Ambulance workers","Fire-fighters", "Food processing and related trades workers", "Medical assistants", "Stock clerks", "Physiotherapists", "Dentists"  
      * Occupation category is "Protective services workers" & profession is not "Fonctionnaire"  
      * Profession is "Vendeuse"  
      * Occupation category is "Life science technicians and related associate professionals" & profession is not "Assistante diplômée"   
* `wfh_change` which gives an indication of whether or not their WFH frequency changed over the pandemic (increase, no change, decrease)

**Other explanatory variables of interest:** These have all been queried in the inclusion questionnaire  

* `age_cat`
* `sex_en`
* `education_rec_en`
* `hh_income_cat_en`
* `finance_situation`
* `percent_change_cat` --> Did their rate of work change between the inclusion questionnaire and sante-travail?
* `supervision_short` --> Responses to whether or not they manage people
* `hh_livewith_rec_en`
* `overcrowded` --> Number of people living in the dwelling divided by the number of bedrooms (ratio > 2 = "Overcrowded")
* `noisy`
* `quiet_room` --> has access to a quiet room in the dwelling
* `teleworkability` --> not sure about including
* `health_general_dich`  
  
  
```{r}
# define main exposure and other explanatory variables of interest - can be used for linear and logistic regressions
mcovariates <- c("wfh_exposure",
                 "age_cat","sex_en","education_rec_en",
                  "hh_income_cat_en", "finance_situation", "percent_change_cat", "supervision_short", # which variable to use for financial security? or too linked with income?
                 "hh_livewith_rec_en", "overcrowded", # "zone_house" to be added as well?
                 "noisy", "quiet_room", 
                 "smoking_rec_en",
                 # "teleworkability",
                 # "work_interruption",
                 "health_general_dich"
                 )
```
  
  
From "Essential Medical Statistics":  
**Estimating the effect of a particular exposure**  
_When estimating the effect of a particular exposure, we have seen that it is important to include potential confounding variables in the regression model, and that failure to do so will lead to a biased estimate of the effect. In considering which potential confounders should be included, it is essential that careful consideration be given to hierarchical relationships between exposures and confounders, as well as to statistical associations in the data. This is explained in detail in Chapter 38 on strategies for data analysis._

**Developing an explanatory model for the outcome**  
_Sometimes the focus of a study is to understand the aetiology of the outcome, and to identify those exposures or risk factors that are important influences on it. The purpose of the regression model here is halfway between that of the other two situations just described. Thus the focus is neither on identifying which confounders to include for a particular risk factor, nor is it on identifying any combination of exposures that works, as in the prediction scenario. Instead it is intended to attach meaning to the variables chosen for inclusion in the final model. For this reason, we strongly recommend that the selection procedure is based on an underlying conceptual framework (see Chapter 38 for more detail), and that formal stepwise methods are avoided_

## Teleworkability
Inclusion of teleworking indices from ISCO classifications of profession.y variable
```{r}
ggplotly( dat %>% 
  ggplot(aes(x = physical_interaction, y = social_interaction, color = wfh_trich, label = paste(profession.y, "\n", Occupation_label)))+
  geom_point()+
  labs(color = "Teleworking")+
  geom_hline(yintercept = 0.5)+
  geom_vline(xintercept = 0.4)+
  theme_bw())
```



## Regressions {.tabset}

### Linear {.tabset}
From "Essential Medical Statistics":  
_"For multiple linear regression, you should aim to include all exposure variables that are clearly associated with the outcome when estimating the effect of a particular exposure, whether or not they are confounders (with the exception that variables on the causal pathway between the exposure of interest and the outcome should not be included)"_

#### EE-MBI (no transformation)
```{r}
# Univariate model with variables of interest
eembi_n <- dat %>%
  select(all_of(mcovariates)) %>%
  tbl_summary(
    type = all_categorical() ~ "categorical",                 # force all categorical levels to display
    missing_text = "Missing"                                   # how missing values should display
  ) %>%
  add_n() %>%
  # add_n(location = "level") %>% 
  bold_labels() %>% 
  italicize_levels()
  
uv_eembi <- dat %>%
  select(burnout_score, all_of(mcovariates)) %>%
  tbl_uvregression(
    method = glm,
    y = burnout_score,
    method.args = list(family = gaussian),
    exponentiate = FALSE,
    hide_n = TRUE,
    pvalue_fun = ~ style_pvalue(.x, digits = 2)
  ) %>%
  # add_global_p() %>% # add global p-value
  # add_nevent() %>% # add number of events of the outcome
  # add_q() %>% # adjusts global p-values for multiple testing
  bold_p() %>% # bold p-values under a given threshold (default 0.05)
  # bold_p(t = 0.10, q = TRUE) %>% # now bold q-values under the threshold of 0.10
  # add_n() %>%
  bold_labels() #%>% 
  # as_gt() %>%
  # gt::tab_header(title = "Univariate linear regression",
  #                subtitle = "EE-MBI score (continuous)")

# # Manual entry of GLM model
# m1 <- glm(data = dat,
#           burnout_score_sqrt1 ~ wfh_exposure+age_cat+sex_en+education_rec_en+
#             hh_income_cat_en+finance_situation+hh_livewith_rec_en+overcrowded+noisy+quiet_room+health_general_dich,
#           family = gaussian)
# 
# # Plot residuals
# autoplot(m1)
# # Organize outputs into a table
# tbl_regression(m1,
#                pvalue_fun = ~ style_pvalue(.x, digits = 2)
# ) %>%
#   bold_p() %>%
#   bold_labels()

# Automated writing out of multivariable equation
outcome <- "burnout_score"           # Define outcome
# Create model
m1_formula <- mcovariates %>%                      ## begin with vector of explanatory column names
  str_c(collapse = " + ") %>%                 ## combine all names of the variables of interest separated by a plus
  str_c(outcome," ~ ", .)                   ## combine the names of variables of interest with outcome in formula style
m1 <- m1_formula %>% 
  glm(family = "gaussian",                  ## define type of glm as linear
      data = dat)                          ## define your dataset

# Plot residuals
autoplot(m1)
```


**Check for collinearity**
```{r}
# Collinearity
car::vif(m1)
# Organize outputs into a table
mv_eembi <- tbl_regression(m1,
               pvalue_fun = ~ style_pvalue(.x, digits = 2),
               intercept = TRUE
) %>%
  bold_p() %>%
  bold_labels()
```

**Table combining univariable and multivariable linear regressions for continuous EE-MBI score**
```{r}
tbl_merge(
  tbls = list(eembi_n, uv_eembi, mv_eembi),
  tab_spanner = c(" ", "**Univariable regression**", "**Multivariable regression**")
)
```

### Logistic EE-MBI

**Need to check assumptions of logistic regression:**  

* Linear relationship between continuous independent variables and log-odds of outcome  
  * We have no continuous predictors, so all ok  
* No highly influential outlier data points, as they can distort the outcome and accuracy of the model.  
  * Still need to verify this (Cook's Distance and standardized residuals?)  
* Absence of multicollinearity  
  * Still need to check  
* Independence of observations  
  * Still need to check --> ok for us to have variables measured in previous questionnaire?
* Sufficiently large sample size (~ at least 10 observations within the least frequent outcome for each independent variable)  
  * Still need to check  
  
```{r, warning=FALSE}
# Create multivariate regression model
#### Dichotomised EE-MBI score
severe <- 30 # cutoff for whether MBI score is classified as severe or not
a <- dat %>% mutate(
  Severe_MBI = case_when(
    burnout_score >= severe ~ 1,
    burnout_score < severe ~ 0,
    .default = burnout_score))
```

```{r, warning=FALSE}
# Univariable logistic regression


uv_eembi_log <- a %>%
  select(Severe_MBI, all_of(mcovariates)) %>%
  tbl_uvregression(
    method = glm,
    y = Severe_MBI,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    pvalue_fun = ~ style_pvalue(.x, digits = 2),
    hide_n = FALSE
  ) %>%
  # add_global_p() %>% # add global p-value
  add_nevent(location = "level") %>% # add number of events of the outcome
  # add_q() %>% # adjusts global p-values for multiple testing
  bold_p() %>% # bold p-values under a given threshold (default 0.05)
  # bold_p(t = 0.10, q = TRUE) %>% # now bold q-values under the threshold of 0.10
  add_n(location = "level") %>%
  bold_labels() #%>% 
  # as_gt() %>%
  # gt::tab_header(title = "Univariate logistic regression",
  #                subtitle = paste0("Severe = 1 when EE-MBI >= ",severe))


# Automatic inclusion of pre-defined explanatory variables
outcome <- "Severe_MBI"           # Define outcome
# Create model
m2 <- mcovariates %>%                      ## begin with vector of explanatory column names
  str_c(collapse = "+") %>%                 ## combine all names of the variables of interest separated by a plus
  str_c(outcome," ~ ", .) %>%    ## combine the names of variables of interest with outcome in formula style
  glm(family = "binomial",                  ## define the family as binomial for logistic regression
      data = a)                          ## define your dataset
```

**Check for collinearity**
```{r, warning=FALSE}
# Collinearity
car::vif(m2)
# Organize outputs into a table
mv_eembi_log <- tbl_regression(m2,
               exponentiate = TRUE,
               pvalue_fun = ~ style_pvalue(.x, digits = 2)
) %>%
  bold_p() %>%
  bold_labels()
```

**Table combining Univariable and Multivariable logistic regressions for dichotomised EE-MBI score (score >= `r severe` = 1)**
```{r}
tbl_merge(
  tbls = list(uv_eembi_log, mv_eembi_log),
  tab_spanner = c("**Univariable regression**", "**Multivariable regression**")
)
```

### Logistic Diagnosed Burnout
```{r, warning=FALSE}
# Univariable logistic regression
uv_dbo_log <- dat %>%
  select(burn_out, all_of(mcovariates)) %>%
  tbl_uvregression(
    method = glm,
    y = burn_out,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    pvalue_fun = ~ style_pvalue(.x, digits = 2),
    hide_n = FALSE
  ) %>%
  # add_global_p() %>% # add global p-value
  add_nevent(location = "level") %>% # add number of events of the outcome
  # add_q() %>% # adjusts global p-values for multiple testing
  bold_p() %>% # bold p-values under a given threshold (default 0.05)
  # bold_p(t = 0.10, q = TRUE) %>% # now bold q-values under the threshold of 0.10
  add_n(location = "level") %>%
  bold_labels() #%>% 
  # as_gt() %>%
  # gt::tab_header(title = "Univariate logistic regression",
  #                subtitle = paste0("Severe = 1 when EE-MBI >= ",severe))


# Automatic inclusion of pre-defined explanatory variables
outcome <- "burn_out"           # Define outcome
# Create model
m3 <- mcovariates %>%                      ## begin with vector of explanatory column names
  str_c(collapse = "+") %>%                 ## combine all names of the variables of interest separated by a plus
  str_c(outcome," ~ ", .) %>%    ## combine the names of variables of interest with outcome in formula style
  glm(family = "binomial",                  ## define the family as binomial for logistic regression
      data = dat)                          ## define your dataset
```

**Check for collinearity**
```{r, warning=FALSE}
# Collinearity
car::vif(m2)
# Organize outputs into a table
mv_dbo_log <- tbl_regression(m3,
               exponentiate = TRUE,
               pvalue_fun = ~ style_pvalue(.x, digits = 2)
) %>%
  bold_p() %>%
  bold_labels()
```

**Table combining Univariable and Multivariable logistic regressions for Diagnosed Burnout in last 12 months**
```{r}
tbl_merge(
  tbls = list(uv_dbo_log, mv_dbo_log),
  tab_spanner = c("**Univariable regression**", "**Multivariable regression**")
)
```

### Logistic Harmonized Burnout
```{r, warning=FALSE}
# Univariable logistic regression
uv_bo_definition_log <- dat %>%
  select(burnout_harmonized, all_of(mcovariates)) %>%
  tbl_uvregression(
    method = glm,
    y = burnout_harmonized,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    pvalue_fun = ~ style_pvalue(.x, digits = 2),
    hide_n = FALSE
  ) %>%
  # add_global_p() %>% # add global p-value
  add_nevent(location = "level") %>% # add number of events of the outcome
  # add_q() %>% # adjusts global p-values for multiple testing
  bold_p() %>% # bold p-values under a given threshold (default 0.05)
  # bold_p(t = 0.10, q = TRUE) %>% # now bold q-values under the threshold of 0.10
  add_n(location = "level") %>%
  bold_labels() #%>% 
  # as_gt() %>%
  # gt::tab_header(title = "Univariate logistic regression",
  #                subtitle = paste0("Severe = 1 when EE-MBI >= ",severe))


# Automatic inclusion of pre-defined explanatory variables
outcome <- "burnout_harmonized"           # Define outcome
# Create model
m4 <- mcovariates %>%                      ## begin with vector of explanatory column names
  str_c(collapse = "+") %>%                 ## combine all names of the variables of interest separated by a plus
  str_c(outcome," ~ ", .) %>%    ## combine the names of variables of interest with outcome in formula style
  glm(family = "binomial",                  ## define the family as binomial for logistic regression
      data = dat)                          ## define your dataset
```

**Check for collinearity**
```{r, warning=FALSE}
# Collinearity
car::vif(m2)
# Organize outputs into a table
mv_bo_definition_log <- tbl_regression(m4,
               exponentiate = TRUE,
               pvalue_fun = ~ style_pvalue(.x, digits = 2)
) %>%
  bold_p() %>%
  bold_labels()
```

**Table combining Univariable and Multivariable logistic regressions for Burnout definition**  
i.e. EE-MBI score >= `r severe` AND Exhaustion at work = "Yes"
```{r}
tbl_merge(
  tbls = list(uv_bo_definition_log, mv_bo_definition_log),
  tab_spanner = c("**Univariable regression**", "**Multivariable regression**")
)
```

### Combined table
**Table combining Multivariable linear and logistic regressions**
```{r}
regressions_n <- dat %>%
  select(all_of(mcovariates)) %>%
  tbl_summary(
    type = all_categorical() ~ "categorical",                 # force all categorical levels to display
    missing_text = "Missing"                                   # how missing values should display
  ) %>%
  add_n() %>%
  # add_n(location = "level") %>% 
  bold_labels() %>% 
  italicize_levels()
```


```{r}
tbl_merge(
  tbls = list(regressions_n, mv_eembi, mv_eembi_log, mv_dbo_log),
  tab_spanner = c("N", "**Linear EE-MBI**", paste0("**Logistic EE-MBI (Severe >= ", severe,")**"), "**Logistic Diagnosed Burnout**")
)
```